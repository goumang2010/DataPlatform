<template>
	<div class="bp-container panel-group">
		<div class="nform-box">
			<ul class="clearfix">
				<li class="clearfix">
					<div>
						<label>埋点URL</label>
						<input class="form-control inp inpW1"
						       type="text"
						       placeholder=""
						       v-model="searchParam.pageUrl">
					</div>
					<div>
						<label>埋点名称</label>
						<input class="form-control inp inpW2"
						       type="text"
						       placeholder=""
						       v-model="searchParam.pointName">
					</div>
					<div>
						<label>状态</label>
						<select class="form-control inp inpW2"
						        v-model="searchParam.isActive">
							<option value='1'>正常</option>
							<option value='0'>已删除</option>
						</select>
					</div>
					<div>
						<label>埋点事件</label>
						<input class="form-control inp inpW2"
						       type="text"
						       placeholder=""
						       value="单击"
						       disabled>
					</div>
				</li>
				<li>
					<div>
						<label>匹配模式</label>
						<input class="form-control inp inpW1"
						       type="text"
						       placeholder=""
						       v-model="searchParam.pattern">
					</div>
					<div>
						<label>平台</label>
						<select class="form-control inp inpW2"
						        v-model="searchParam.platform">
							<option value='PC'>PC</option>
							<option value='H5'>H5</option>
						</select>
					</div>
					<div>
						<label>是否模块</label>
						<select class="form-control inp inpW2"
						        v-model="searchParam.type">
							<option value=''>全部</option>
							<option value='block'>模块</option>
							<option value='point'>单点</option>
						</select>
					</div>
	
				</li>
				<li>
					<div>
						<label>
							<input type="checkbox"
							       v-model="showDate"></input>起止时间</label>
						<div class="date_picker">
							<m-date :index="index"
							        :page-components-data="pageComponentsData"
							        :component-type="'date_picker'"
							        :argvs.sync='argvs'
							        :custom-option="datepickerOption"
							        :cancel-date-limit="1"
							        diasbled></m-date>
						</div>
					</div>
	
					<button id="btnSearch"
					        class="btn btn-search btn-primary"
					        type="button"
					        data-toggle="popover"
					        data-trigger="focus"
					        @click="queryClick">查询</button>
	
				</li>
			</ul>
		</div>
		<div class="list-cot list-cot-h list-group">
			<table class="table table-hover ntable">
				<thead>
					<tr>
						<th>序号</th>
						<th>埋点名称</th>
						<th>事件</th>
						<th>是否模块</th>
						<th>页面URL</th>
						<th>匹配模式</th>
						<th>埋点参数</th>
						<th>修改人</th>
						<th>埋点设置时间</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody>
					<tr v-for="(i, item) in dataList">
						<td>{{i + baseIndex}}</td>
						<td title="{{item.pointName}}">{{item.pointName}}</td>
						<td>单击</td>
						<td title="{{item.type}}">{{item.type === 'block' ? '是' : '否'}}</td>
						<td title="{{item.pageUrl}}"><a @click="heatmap(item)">{{item.pageUrl}}</a></td>
						<td title="{{item.pattern}}">{{item.pattern || '-'}}</td>
						<td title="{{item.pointParam}}">{{item.pointParam || '-'}}</td>
						<td title="{{item.userInfo?(item.userInfo.department + item.userInfo.email) : '--'}}">{{item.userInfo.name || '--'}}</td>
						<td title="{{item.updateTime |Date 'yyyy-MM-dd hh:mm:ss'}}">{{item.updateTime |Date 'yyyy-MM-dd hh:mm:ss'}}</td>
						<td v-if="item.isActive === '1'"><a v-if="item.uniquePoint !== '2'"
							   @click="edit(item)">修改</a>&nbsp<a v-if="item.isActive === '1' && item.uniquePoint !== '2'"
							   @click="del(item)">删除</a></td>
						<!--<a v-if="item.isActive === '0'" @click="restore(item)">恢复</a>-->
						<td v-else> -- </td>
					</tr>
					<tr v-show="noData">
						<td colspan="10">暂无数据</td>
					</tr>
				</tbody>
			</table>
		</div>
		<div class="panel-footer"
		     v-show="paginationConf.totalItems > paginationConf.itemsPerPage">
			<m-pagination :pagination-conf="paginationConf"></m-pagination>
		</div>
	</div>
</template>
<script>
var Vue = require('Vue');
var $ = require('jQuery');
var DatePicker = require('common/datePicker.vue');
var store = require('store');
var actions = require('actions');
var Pagination = require('common/pagination.vue');
var api = require('./api');
var utils = require('utils');

var databp = Vue.extend({
	name: 'bpmanage',
	components: {
		'm-pagination': Pagination,
		'm-date': DatePicker
	},
	props: ['loading'],
	computed: {
		baseIndex: function () {
			return (this.paginationConf.currentPage - 1) * this.paginationConf.itemsPerPage + 1;
		}
	},
	data: function () {
		return {
			index: 1,
			noData: false,
			showDate: null,
			argvs: {},
			paginationConf: {
				currentPage: 1,     // 当前页
				totalItems: 0,     // 总条数
				itemsPerPage: 10,    // 每页条数
				pagesLength: 5,     // 显示几页( 1,2,3 / 1,2,3,4,5)
				onChange: () => {
					this.query();
				}
			},
			datepickerOption: {
				opens: 'right'
			},
			pageComponentsData: {
				date_picker: {
					show: true,
					defaultData: 90,
					showDayUnit: true
				},
				trigger: true
			},
			dataList: [],
			searchParam: {
				pointName: '',
				platform: 'PC',
				pageUrl: '',
				pattern: '',
				isActive: '1',
				type: ''
			}
		}
	},
	ready() {
		this.showDate = false;
	},
	route: {
		activate: function (transition) {
			this.query();
			return Promise.resolve(true);
		}
	},
	methods: {
		query() {
			this.loading.show = true;
			let options = Object.assign({
				// page从0开始
				page: this.paginationConf.currentPage - 1,
				size: this.paginationConf.itemsPerPage
			}, this.searchParam);
			if (this.showDate) {
				options.startTime = this.argvs.startTime + ' 00:00:00';
				options.endTime = this.argvs.endTime + ' 23:59:59';
			} else {
				options.startTime = '2000-01-01 00:00:00';
				options.endTime = utils.formatDate(new Date(), 'yyyy-MM-dd hh:mm:ss');
			}
			api.listBps(options).then((res) => {
				this.dataList = res.data;
				if (this.dataList.length === 0) {
					this.noData = true;
				} else {
					this.noData = false;
				}

				this.paginationConf.totalItems = res.total;
				this.loading.show = false;
			}).catch((err) => {
				console.log(err);
				this.loading.show = false;
			});
		},
		del(item) {
			actions.confirm(store, {
				show: true,
				title: '删除确认',
				msg: '确定删除吗',
				apply: () => {
					api.deleteBp(item).then(() => {
						this.query()
					});

				}
			});
		},
		restore(item) {
			actions.confirm(store, {
				show: true,
				title: '确认恢复',
				msg: '确认恢复吗',
				apply: () => {
					api.restoreBp(item).then(() => {
						this.query();
					});
				}
			});
		},
		queryClick() {
			this.paginationConf.currentPage = 1;
			this.query();
		},
		edit(item) {
			let { pageUrl, pointName, pointParam, selector, platform, type } = item;
			this.$router.go({
				path: '/databp/visualbp',
				query: { pageUrl, pointName, pointParam, selector, platform, type }
			});
		},
		heatmap(item) {
			let { pageUrl, platform } = item;
			this.$router.go({
				path: '/databp/heatmap',
				query: { pageUrl, platform }
			});
		}
	},
	watch: {
		'showDate': {
			handler(val) {
				let $dateInput = $('.date_picker input');
				if (val) {
					// triger the date picker
					this.pageComponentsData.trigger = !this.pageComponentsData.trigger;
					$dateInput.removeAttr("disabled");
				} else {
					$dateInput.attr('disabled', true);
					$dateInput.val('');

				}
			}
		}
	}
});

module.exports = databp;
</script>
<style scoped>
.bp-container {
	height: 100% !important;
	min-height: 600px;
	overflow: hidden;
	margin: -20px -15px;
}

.nform-box {
	border-bottom: 1px solid #ccc !important;
	background-color: #efefef;
	position: relative;
}

.nform-box .inp {
	font-size: 12px;
}

.nform-box ul {
	width: 100%;
	margin: 0 auto;
	padding: 11px;
	padding-bottom: 2px;
}

.nform-box ul li {
	display: flex;
	justify-content: flex-start;
	overflow: hidden;
	padding-bottom: 6px;
	list-style: none;
	margin-bottom: 10px;
	padding: 0;
}

.nform-box ul>li>div {
	display: flex;
	margin-right: 5%;
	min-width: 170px;
}

.nform-box ul li label {
	margin: 0 18px 0 0;
	padding: 0;
	font-weight: normal !important;
	font-size: 12px !important;
	line-height: 28px;
	display: inline-block;
	min-width: 50px;
}

.nform-box ul li .date_picker {
	margin-left: -5px;
	float: left;
	min-width: 220px;
}

.nform-box li label,
.nform-box li a,
.nform-box li input,
.nform-box li button,
.nform-box li select {
	float: left;
}

.nform-box ul li input,
.nform-box ul li select {
	max-height: 30px;
	border-color: #c2c2c2 !important;
}

.nform-box ul li .inpW1 {
	max-width: 200px;
}

.nform-box ul li .inpW2 {
	max-width: 100px;
}

.nform-box ul li input:last-child {
	margin-right: 0px;
}

.nform-box ul li input[type="checkbox"] {
	margin-top: 8px;
	margin-right: 4px;
}

.nform-box li .btn-search {
	margin: 0 0 0 46%;
	width: 80px;
}

.list-cot-h {
	height: -moz-calc(100% - 166px);
	height: -webkit-calc(100% - 166px);
	height: calc(100% - 166px);
	background: #fff;
	overflow: auto;
}

.list-cot .ntable {
	border-top-color: #999;
}

.ntable {
	border-top: 1px solid #d6d6d6;
	border-bottom: 1px solid #d6d6d6;
	font-size: 12px;
	table-layout: fixed;
}

.ntable thead tr th,
.ntable tbody tr th,
.ntable tbody tr td,
.ntable tbody tr td .pop {
	height: 30px;
	padding: 0 2px;
	font-weight: normal;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
	line-height: 30px;
}

.ntable thead tr th {
	text-align: center;
	border-top: 1px solid #d6d6d6;
	border-left: 1px solid #d6d6d6;
	border-bottom: 1px solid #d6d6d6;
	font-weight: normal;
}

.ntable tr:nth-child(odd) {
	background-color: #f2faff;
}

.ntable tr th:nth-child(3) {
	width: 50px;
}

.ntable tr th:first-child {
	width: 50px;
}

.ntable tr th:last-child {
	width: 80px;
}

.ntable tr th:first-child {
	width: 5%
}

.ntable tr th:nth-child(5) {
	width: 300px;
}

.ntable tr th:nth-child(6) {
	width: 200px;
}

.ntable tr th:nth-child(8) {
	width: 80px;
}

.ntable tr td {
	text-align: center;
}

.ntable tr a {
	cursor: pointer;
}
</style>
